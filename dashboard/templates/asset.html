<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Detail - SecGuys Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">üõ°Ô∏è</span>
                    <span class="logo-text">SecGuys</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/" class="nav-item">
                    <span class="icon">üìä</span> Dashboard
                </a>
                <a href="/" class="nav-item active">
                    <span class="icon">üéØ</span> Asset Detail
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1 id="asset-name">Asset Detail</h1>
                    <p class="subtitle">Comprehensive vulnerability assessment</p>
                </div>
                <div class="header-right">
                    <a href="/" class="btn btn-primary">‚Üê Back to Dashboard</a>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <div class="section active">
                    <!-- Asset Summary -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Asset Information</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                                <div>
                                    <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.5rem;">Primary Identifier</div>
                                    <div id="primary-id" style="font-size: 1.3rem; color: var(--lighter); font-weight: 600;"></div>
                                </div>
                                <div>
                                    <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.5rem;">Asset Type</div>
                                    <div id="asset-type" style="font-size: 1.3rem; color: var(--primary); font-weight: 600;"></div>
                                </div>
                                <div>
                                    <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.5rem;">Created</div>
                                    <div id="created-at" style="font-size: 1.3rem; color: var(--lighter); font-weight: 600;"></div>
                                </div>
                            </div>

                            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                <h4 style="color: var(--lighter); margin-bottom: 1rem;">Identifiers</h4>
                                <div id="identifiers-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Severity Summary -->
                    <div class="dashboard-grid" style="margin-top: 2rem;">
                        <div class="card">
                            <div class="card-header">
                                <h3>Severity Summary</h3>
                            </div>
                            <div class="card-body">
                                <div id="severity-summary" style="display: grid; gap: 1rem;"></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>Asset Severity Distribution</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="asset-severity-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Scan History -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <h3>Scan History</h3>
                        </div>
                        <div class="card-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                <div id="scan-history" class="stat-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Findings -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <h3>Recent Findings (Top 20)</h3>
                            <select id="finding-filter" class="form-control" style="width: 200px;">
                                <option value="">All Severities</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="info">Informational</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div id="findings-list" style="max-height: 600px; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <!-- Classification Breakdown -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <h3>Attack Classification</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="asset-classification-chart"></canvas>
                        </div>
                    </div>

                    <!-- MITRE Mapping -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <h3>MITRE ATT&CK Techniques</h3>
                        </div>
                        <div class="card-body">
                            <div id="asset-mitre-list" class="stat-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Get asset ID from URL
        const assetId = new URLSearchParams(window.location.search).get('id') || '{{ asset_id }}';
        const API_BASE = "/api";

        const state = {
            charts: {},
            findings: []
        };

        // Load asset on page load
        document.addEventListener("DOMContentLoaded", async () => {
            if (!assetId) {
                document.body.innerHTML = '<div style="padding: 2rem; color: white;">Asset ID not found</div>';
                return;
            }
            
            await loadAssetDetail();
        });

        async function loadAssetDetail() {
            try {
                const [assetRes, findingsRes, classRes, mitreRes] = await Promise.all([
                    axios.get(`${API_BASE}/assets/${assetId}`),
                    axios.get(`${API_BASE}/findings/${assetId}`),
                    axios.get(`${API_BASE}/analytics/classification-breakdown?asset_id=${assetId}`),
                    axios.get(`${API_BASE}/analytics/mitre-mapping?asset_id=${assetId}`)
                ]);

                const asset = assetRes.data.asset;
                state.findings = findingsRes.data.findings;

                // Update header
                document.getElementById("asset-name").textContent = asset.primary_identifier;
                document.getElementById("primary-id").textContent = asset.primary_identifier;
                document.getElementById("asset-type").textContent = asset.asset_type;
                document.getElementById("created-at").textContent = new Date(asset.created_at).toLocaleDateString();

                // Identifiers
                document.getElementById("identifiers-list").innerHTML = asset.identifiers.map(id => `
                    <div style="background: rgba(99, 102, 241, 0.1); padding: 1rem; border-radius: 6px;">
                        <div style="color: var(--text-light); font-size: 0.85rem;">${id.type}</div>
                        <div style="color: var(--lighter); font-weight: 600; word-break: break-all;">${id.value}</div>
                    </div>
                `).join("");

                // Severity summary
                document.getElementById("severity-summary").innerHTML = Object.entries(asset.severity_summary || {}).map(([severity, count]) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(99, 102, 241, 0.05); border-radius: 6px; border-left: 4px solid var(--primary);">
                        <span style="text-transform: capitalize; color: var(--lighter);">${severity}</span>
                        <span style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${count}</span>
                    </div>
                `).join("");

                // Charts
                renderAssetSeverityChart(asset.severity_summary);
                renderAssetClassificationChart(classRes.data.classifications);
                renderAssetMitreList(mitreRes.data.mitre);

                // Scan history
                document.getElementById("scan-history").innerHTML = asset.scans.map(scan => `
                    <div class="stat-item">
                        <div>
                            <div class="stat-item-name">${scan.tool}</div>
                            <div style="color: var(--text-light); font-size: 0.85rem;">${new Date(scan.started_at).toLocaleString()}</div>
                        </div>
                        <div class="severity-badge severity-${scan.status === 'completed' ? 'info' : 'medium'}">${scan.status}</div>
                    </div>
                `).join("");

                // Findings
                renderFindings(state.findings);

                // Filter handler
                document.getElementById("finding-filter").addEventListener("change", (e) => {
                    const severity = e.target.value;
                    const filtered = severity ? state.findings.filter(f => f.severity === severity) : state.findings;
                    renderFindings(filtered);
                });

            } catch (error) {
                console.error("Load error:", error);
                document.body.innerHTML += '<div style="padding: 2rem; color: red;">Failed to load asset data</div>';
            }
        }

        function renderFindings(findings) {
            const container = document.getElementById("findings-list");
            
            if (findings.length === 0) {
                container.innerHTML = '<div style="color: var(--text-light); padding: 2rem; text-align: center;">No findings</div>';
                return;
            }

            container.innerHTML = findings.slice(0, 20).map(finding => `
                <div style="background: rgba(99, 102, 241, 0.05); padding: 1.5rem; margin-bottom: 1rem; border-radius: 6px; border-left: 4px solid ${getSeverityColor(finding.severity)};">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <div style="color: var(--lighter); font-weight: 600; flex: 1;">${finding.title}</div>
                        <span class="severity-badge severity-${finding.severity}">${finding.severity}</span>
                    </div>
                    <div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.75rem;">${finding.description}</div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                        <div><strong>Source:</strong> ${finding.source}</div>
                        <div><strong>Classification:</strong> ${finding.semantic_classification}</div>
                        <div><strong>CVSS:</strong> <span style="color: var(--primary); font-weight: 600;">${(finding.semantic_cvss || 0).toFixed(1)}</span></div>
                        ${finding.cve ? `<div><strong>CVE:</strong> ${finding.cve}</div>` : ''}
                    </div>
                </div>
            `).join("");
        }

        function getSeverityColor(severity) {
            const colors = {
                critical: "#dc2626",
                high: "#f97316",
                medium: "#eab308",
                low: "#3b82f6",
                info: "#0ea5e9"
            };
            return colors[severity] || "#6366f1";
        }

        function renderAssetSeverityChart(distribution) {
            const ctx = document.getElementById("asset-severity-chart").getContext("2d");
            destroyChart("asset-severity");
            
            state.charts["asset-severity"] = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: Object.keys(distribution),
                    datasets: [{
                        data: Object.values(distribution),
                        backgroundColor: [
                            "rgba(220, 38, 38, 0.8)",
                            "rgba(249, 115, 22, 0.8)",
                            "rgba(234, 179, 8, 0.8)",
                            "rgba(59, 130, 246, 0.8)",
                            "rgba(14, 165, 233, 0.8)"
                        ],
                        borderColor: "rgba(255, 255, 255, 0.1)",
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: "rgba(255, 255, 255, 0.7)",
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }

        function renderAssetClassificationChart(classifications) {
            const ctx = document.getElementById("asset-classification-chart").getContext("2d");
            destroyChart("asset-classification");
            
            state.charts["asset-classification"] = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: classifications.map(c => c.classification),
                    datasets: [{
                        label: "Count",
                        data: classifications.map(c => c.count),
                        backgroundColor: "rgba(99, 102, 241, 0.6)",
                        borderColor: "rgba(99, 102, 241, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: "y",
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            ticks: { color: "rgba(255, 255, 255, 0.5)" },
                            grid: { color: "rgba(255, 255, 255, 0.1)" }
                        },
                        y: {
                            ticks: { color: "rgba(255, 255, 255, 0.7)" },
                            grid: { color: "rgba(255, 255, 255, 0.1)" }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: "rgba(255, 255, 255, 0.7)" }
                        }
                    }
                }
            });
        }

        function renderAssetMitreList(mitreData) {
            const container = document.getElementById("asset-mitre-list");
            
            if (mitreData.length === 0) {
                container.innerHTML = '<div style="color: var(--text-light);">No MITRE techniques discovered</div>';
                return;
            }

            container.innerHTML = mitreData.slice(0, 15).map(item => `
                <div class="stat-item">
                    <div>
                        <div class="stat-item-name">${item.tactic}</div>
                        <div style="color: var(--text-light); font-size: 0.85rem;">${item.technique}</div>
                    </div>
                    <div class="stat-item-count">${item.count}</div>
                </div>
            `).join("");
        }

        function destroyChart(key) {
            if (state.charts[key]) {
                state.charts[key].destroy();
                delete state.charts[key];
            }
        }
    </script>
</body>
</html>
