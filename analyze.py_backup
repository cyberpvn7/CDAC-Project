import google.generativeai as genai
import json
import os
import time

# ğŸ”‘ Integrated API Key
API_KEY = ""

def analyze_vulnerabilities():
    print("ğŸ¤– Starting AI Predictive Analysis (2025 Optimized) ğŸš€")

    # 1. Check for the data file
    if not os.path.exists("final.json"):
        print("âŒ Error: 'final.json' not found! Please run your bash script first. ğŸ“")
        return

    try:
        # 2. Configure the API
        genai.configure(api_key=API_KEY)
        
        # ğŸ’¡ USING FLASH-LITE: This model has the highest free-tier availability in Dec 2025.
        model = genai.GenerativeModel('gemini-2.5-flash-lite')
        
        # 3. Load Normalized Data
        with open("final.json", "r") as f:
            scan_data = json.load(f)

        # 4. Craft the Predictive Prompt
        prompt = f"""
        Act as a Cyber Security Predictive Analyst. ğŸ•µâ™‚
        Analyze this scan data from a Metasploitable2 target (192.168.74.91).
        
        DATA:
        {json.dumps(scan_data, indent=2)}

        PLEASE PROVIDE:
        1. ğŸš¨ TOP 3 CRITICAL EXPLOITS: Identify the most dangerous vulnerabilities.
        2. â›“ ATTACK CHAIN: How would an attacker move from entry to Root access?
        3. ğŸŒ¡ RISK SCORE (0-100): Based on actual exploit availability.
        4. ğŸ›  REMEDIATION: Step-by-step fixes for a sysadmin.

        Format with Markdown and use emoticons. Keep it professional. ğŸ“Š
        """

        # 5. Generate with Retry Logic (Handles 429 errors gracefully)
        print("ğŸ›° Connecting to Gemini 2.5 Flash-Lite... (Wait 5s to avoid rate-limit)")
        time.sleep(5) 
        
        response = model.generate_content(prompt)
        report_output = response.text

        # 6. Display and Save
        print("\n" + "â•"*60)
        print("ğŸ“ PREDICTIVE RISK REPORT")
        print("â•"*60 + "\n")
        print(report_output)

        with open("ai_report.md", "w") as f:
            f.write(report_output)
        
        print(f"\nâœ… SUCCESS! Full report saved to 'ai_report.md' ğŸ“„")

    except Exception as e:
        if "429" in str(e):
            print("\nğŸ›‘ QUOTA ERROR: The free tier is currently congested.")
            print("ğŸ’¡ TIP: Wait 60 seconds or try switching to 'gemini-1.5-flash'.")
        else:
            print(f"âŒ Error encountered: {e} âš ")

if __name__ == "__main__":
    analyze_vulnerabilities()
